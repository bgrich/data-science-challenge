---
title: "Exploratory Data Analysis"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

```{r setup, message = FALSE}
library(tidyverse)
library(jsonlite)

report_theme <- ggplot2::theme_bw() +
  ggplot2::theme(panel.border = ggplot2::element_rect(color = "black",
                                                      fill = NA),
                 panel.grid.major = ggplot2::element_line(color = "black",
                                                          linetype = "dotted"),
                 panel.grid.minor = ggplot2::element_line(color = "black",
                                                          linetype = "dotted"))
```

In this notebook I will be doing an exploratory data analysis looking to answer 
the question: 

> What factors correlate with users booking?

Particularly, I'm interesting in looking at what factors correlate with the 
conversion of leads to bookings. As such, I will primarily work with the leads 
data set with relevant information from the referral data set and a logical 
column indicating a booking event.

# Data Import and Preparation

First, I need to import and prepare the data for analysis.

```{r, message = FALSE}
room_key_data <- read_tsv("data.tsv", progress = FALSE) %>% 
  rownames_to_column() %>% 
  rename(key = rowname) %>% 
  mutate(lead_event = !(lead == "null"), 
         booking_event = !(booking == "null"))
```

```{r}
referral_key <- room_key_data %>% 
  filter(referral != "null") %>% 
  select(key, lead_event, booking_event)

referral <- room_key_data %>% 
  filter(referral != "null") %>%
  .$referral %>% 
  map_df(fromJSON) %>% 
  bind_cols(referral_key) %>% 
  select(key, everything()) %>% 
  rename(visitor_id = `visitor-id`, 
         event_id_referral = `event-id`, 
         ts_referral = ts,
         location_tid = `location-tid`, 
         partner_code = `partner-code`, 
         check_in = `check-in`, 
         check_out = `check-out`)
```

```{r}
lead_key <- room_key_data %>% 
  filter(lead != "null") %>% 
  select(key, booking_event)

lead <- room_key_data %>% 
  filter(lead != "null") %>%
  .$lead %>% 
  map_df(fromJSON) %>% 
  bind_cols(lead_key) %>% 
  select(key, everything()) %>% 
  rename(visitor_id = `visitor-id`, 
         event_id_lead = `event-id`, 
         ts_lead = ts, 
         rate_partner = `rate-partner`)
```

```{r}
booking_key <- room_key_data %>% 
  filter(booking != "null") %>% 
  select(key)

booking <- room_key_data %>% 
  filter(booking != "null") %>%
  .$booking %>%  
  map_df(fromJSON) %>% 
  bind_cols(booking_key) %>% 
  select(key, everything())
```

## Preparation

Here I want to combine some information from the referral data set into the 
lead data set. As part of this, I also rename a few columns and convert 
some of the columns to different data types. Specifically the ts columns are 
converted to datetime and the check_in and check_out columns are converted 
to dates.

```{r}
referral_info <- referral %>% 
  filter(lead_event == TRUE) %>% 
  select(-event_id_referral, -type, -lead_event, -booking_event)

lead_ref <- lead %>% 
  select(-event_id_lead, - type) %>% 
  left_join(referral_info, by = c("key", "visitor_id")) %>% 
  rename(rate_partner_lead = rate_partner, 
         partner_code_referral = partner_code) %>% 
  mutate(ts_lead = lubridate::as_datetime(ts_lead / 1000), 
         ts_referral = lubridate::as_datetime(ts_referral / 1000), 
         check_in = lubridate::ymd(check_in), 
         check_out = lubridate::ymd(check_out))
```

```{r}
lead_ref
```

# Analysis

The following are some initial questions looking at how some of the variables 
interact. 

## Time Difference 

I want to look at whether or not the time difference between lead and referral 
corresponds with a booking.

```{r}
lead_ref %>% 
  mutate(ts_time_diff = as.numeric(ts_lead - ts_referral)) %>% 
  # filter(ts_time_diff < 3000) %>%
  ggplot(aes(x = booking_event, y = ts_time_diff)) + 
  geom_boxplot()
```

```{r}
lead_ref %>% 
  mutate(ts_time_diff = as.numeric(ts_lead - ts_referral)) %>% 
  filter(ts_time_diff < 3000) %>%
  ggplot(aes(x = booking_event, y = ts_time_diff)) + 
  geom_boxplot()
```

```{r}
lead_ref %>% 
  mutate(ts_time_diff = as.numeric(ts_lead - ts_referral)) %>% 
  filter(ts_time_diff < 500) %>%
  ggplot(aes(x = ts_time_diff, fill = booking_event)) + 
  geom_histogram(binwidth = 10) + 
  facet_grid(booking_event ~ ., scales = "free_y")
```

There does not appear to be a large difference between the times at which 
booking events occur or don't occur. There is possibly a greater concentation 
of booking events at short times (time difference < 100 s), but both display a 
similar tail at large time differences. 

## Check-in Time Difference

Here I want to look at the time difference between the proposed check-in date 
and both the referral and lead time stamp date.

First, I want to look at the presence of any NAs in the date differences. 

```{r}
lead_ref %>% 
  mutate(ts_time_diff = as.numeric(check_in - lubridate::as_date(ts_referral))) %>%
  group_by(booking_event) %>% 
  summarize(check_in_NA = sum(is.na(check_in)), 
            ts_referral_NA = sum(is.na(ts_referral)), 
            time_diff_NA = sum(is.na(ts_time_diff)))
```

Here I can see that there are a number of NA's in the check-in data and a few
in the timestamp from the referral data. There were no NA's in the timestamp 
for the lead data. Since the check-in NA number and the time difference NA 
number are the same, I can assume that the NA's from the referral data overlap 
with those from the check-in data. 

For this next analysis, I will remove all of the NA's as they cannot contribute.

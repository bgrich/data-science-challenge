---
title: "Exploratory Data Analysis"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

```{r setup, message = FALSE}
library(tidyverse)
library(jsonlite)

report_theme <- ggplot2::theme_bw() +
  ggplot2::theme(panel.border = ggplot2::element_rect(color = "black",
                                                      fill = NA),
                 panel.grid.major = ggplot2::element_line(color = "black",
                                                          linetype = "dotted"),
                 panel.grid.minor = ggplot2::element_line(color = "black",
                                                          linetype = "dotted"))
```

In this notebook I will be doing an exploratory data analysis looking to answer 
the question: 

> What factors correlate with users booking?

# Data Import and Preparation

First, I need to import and prepare the data for analysis.

```{r, message = FALSE}
room_key_data <- read_tsv("data.tsv", progress = FALSE) %>% 
  rownames_to_column() %>% 
  rename(key = rowname) %>% 
  mutate(lead_event = !(lead == "null"), 
         booking_event = !(booking == "null"))
```

```{r}
referral_key <- room_key_data %>% 
  filter(referral != "null") %>% 
  select(key, lead_event, booking_event)

referral <- room_key_data %>% 
  filter(referral != "null") %>%
  .$referral %>% 
  map_df(fromJSON) %>% 
  bind_cols(referral_key) %>% 
  select(key, everything())
```

```{r}
lead_key <- room_key_data %>% 
  filter(lead != "null") %>% 
  select(key)

lead <- room_key_data %>% 
  filter(lead != "null") %>%
  .$lead %>% 
  map_df(fromJSON) %>% 
  bind_cols(lead_key) %>% 
  select(key, everything())
```

```{r}
booking_key <- room_key_data %>% 
  filter(booking != "null") %>% 
  select(key)

booking <- room_key_data %>% 
  filter(booking != "null") %>%
  .$booking %>%  
  map_df(fromJSON) %>% 
  bind_cols(booking_key) %>% 
  select(key, everything())
```

# Analysis

## Time Difference

First, I want to examine how the time difference between the timestamp when the 
referral event occurred and the check-in date compare with booking events.

```{r}
referral %>% 
  mutate(ts = lubridate::as_datetime(ts / 1000), 
         date = lubridate::as_date(ts), 
         check_in = lubridate::ymd(`check-in`), 
         time_diff = as.numeric(check_in - date)) %>% 
  filter(!is.na(time_diff), 
         time_diff >= 0, 
         time_diff < 365) %>% 
  # filter(booking_event == TRUE) %>% 
  ggplot(aes(x = time_diff, fill = booking_event)) +
  geom_histogram(bins = 30) + 
  facet_grid(booking_event ~ ., scales = "free_y") +
  report_theme +
  labs(x = "Check-in Date - Referral Date (days)", 
         y = "Count", 
         fill = "Booking Event")
  
```

Over the span of 0 days to 365 days after the referral date, there does not 
appear to be a time that is correlates with a booking event occuring versus 
not occuring.

## Location-tid
